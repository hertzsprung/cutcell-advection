\subsection{Transport over a mountainous lower boundary}
\label{sec:mountainAdvection}

A two-dimensional transport test over mountains was developed in \citep{schaer2002} to study the effect of terrain-following coordinate transformations on numerical accuracy.  In this standard test, a tracer is positioned aloft and transported horizontally over wave-shaped terrain.  This test presents no particular challenge on cut cell meshes because there is zero velocity and zero tracer density near the ground \citep{good2014}.
Here we present a variation of this standard test that challenges transport schemes on all mesh types.  By positioning the tracer next to the ground and modifying the velocity field, we can assess the accuracy of the cubicFit scheme near the lower boundary.  Results using the cubicFit scheme are compared with the linearUpwind scheme on basic terrain-following, cut cell and slanted cell meshes.

The domain is defined on a rectangular $x$--$z$ plane that is \SI{301}{\kilo\meter} wide and \SI{25}{\kilo\meter} high as measured between parallel boundary edges.  The domain is subdivided into a $301 \times 50$ mesh such that $\Delta x = \SI{1}{\kilo\meter}$ and $\Delta z = \SI{500}{\meter}$.
A boundary condition of $\phi = \SI{0}{\kilo\gram\per\meter\cubed}$ is imposed at the inlet boundary.  The outlet, ground and top boundary conditions are $\partial \phi / \partial n = \SI{0}{\kilo\gram\per\meter\tothe{4}}$ where the derivative is normal to the boundary.

The terrain is wave-shaped, specified by the surface height $h$ such that
\begin{subequations}
\begin{align}
   h(x) &= h^\star \cos^2 ( \alpha x )
%
\intertext{where}
%
   h^\star(x) &= \left\{ \begin{array}{l l}
       h_0 \cos^2 ( \beta x ) & \quad \text{if $| x | < a$} \\
	0 & \quad \text{otherwise}
    \end{array} \right.
\end{align}
\end{subequations}
where $a = \SI{25}{\kilo\meter}$ is the mountain envelope half-width, $h_0 = \SI{5}{\kilo\meter}$ is the maximum mountain height, $\lambda = \SI{8}{\kilo\meter}$ is the wavelength, \(\alpha = \pi / \lambda\) and \(\beta = \pi / (2a)\).  Note that, in order to make this test more challenging, the mountain height $h_0$ is double the mountain height used by \citep{schaer2002}.

Basic terrain-following, cut cell and slanted cell meshes are constructed by modifying the uniform $301 \times 50$ mesh using this terrain profile.
The basic terrain-following method uses a linear decay function so that mesh surfaces become horizontal at the top of the model domain \citep{galchen-somerville1975},
\begin{equation}
	z(x,y) = \left( H - h(x,y) \right) \left( z^\star / H \right) + h(x,y) \label{eqn:btf}
\end{equation}
where $z$ is the geometric height at a horizontal point $(x, y)$, $H$ is the height of the domain, $h(x,y)$ is the surface elevation and $z^\star$ is the computational height of a mesh surface.  If there was no terrain then $h = 0$ and $z = z^\star$.
Cut cell meshes are constructed using the ASAM grid generator \citep{jaehn2015} \TODO{more detail at \url{http://asamwiki.tropos.de/index.php/Grid\_Generator} but is this suitable for citing?}.  Slanted cell meshes are constructed following the approach by \citep{shaw-weller2016}: vertices that are underground are moved up to the surface and zero-area faces and zero-volume cells are removed.  Unlike \citep{shaw-weller2016}, vertices are never moved downwards.  \TODO{to avoid very thin cells, Hilary wants to merge triangular cells together instead}

Cell edges in the central region of the domain are shown in figure~\ref{fig:mountainAdvection-meshes} for each of the three mesh types.
Cells in the BTF mesh are highly distorted over steep slopes (figure~\ref{fig:mountainAdvection-meshes}a) while the cut cell mesh (figure~\ref{fig:mountainAdvection-meshes}b) and slanted cell mesh (figure~\ref{fig:mountainAdvection-meshes}c) are orthogonal everywhere except for cells nearest the ground.

\begin{figure}
	\centering
	\includegraphics{../fig-mountainAdvection-meshes/fig-mountainAdvection-meshes.pdf}
	\caption{Cell edges of (a) basic terrain-following, (b) cut cell, and (c) slanted cell two-dimensional $x$--$z$ meshes used for the tracer transport tests in section~\ref{sec:mountainAdvection}.  The peak mountain height $h_0 = \SI{5}{\kilo\meter}$.  Only the lowest \SI{10}{\kilo\meter} for the central region of the domain in shown.  The entire domain is \SI{301}{\kilo\meter} wide and \SI{25}{\kilo\meter} high.}
	\label{fig:mountainAdvection-meshes}
\end{figure}

Similar to the approach by \citep{shaw-weller2016}, a velocity field is chosen that is everywhere tangential to the surfaces of a terrain-following coordinate, and the coordinate is chosen so that flow is misaligned with the BTF, cut cell and slanted cell meshes away from the ground.
This ensures that flow always crosses mesh surfaces in order to challenge the transport scheme.   This choice also ensures that there is no normal flow at the lower boundary.  A streamfunction $\Psi$ is used so that the discrete velocity field is non-divergent, such that
\begin{equation}
	\Psi(x,z) = -u_0 H_1 \frac{z - h}{H_1 - h} \label{eqn:streamfunc-btf}
\end{equation}
where $u_0 = \SI{10}{\meter\per\second}$, which is the horizontal velocity where $h(x) = 0$.  The velocity field becomes horizontal at $H_1 = \SI{10}{\kilo\meter}$.  Note that $H_1$ is chosen to be much smaller than the domain height $H$ in equation~\eqref{eqn:btf} so that flow crosses the surfaces of the BTF mesh.
The horizontal and vertical components of velocity, $u$ and $w$, are then given by
\begin{align}
	u &= -\frac{\partial \Psi}{\partial z} = u_0 \frac{H_1}{H_1 - h}, \quad w = \frac{\partial \Psi}{\partial x} = u_0 H_1 \frac{\mathrm{d} h}{\mathrm{d} x} \frac{H_1 - z}{\left( H_1 - h \right)^2} \label{eqn:uw-btf} \\
	\frac{\mathrm{d} h}{\mathrm{d} x} &= - h_0 \left[ 
		\beta \cos^2 \left( \alpha x \right) \sin \left( 2 \beta x \right) +
		\alpha \cos^2 \left( \beta x \right) \sin \left( 2 \alpha x \right)
	\right]
\end{align}
The flow is predominantly horizontal with non-zero vertical velocities only above sloping terrain.
Unlike the horizontal transport test in \citep{schaer2002}, the velocity field presented here extends from the top of the domain all the way to the ground.

At $t=\SI{0}{\second}$, a tracer with density $\phi$ is positioned upwind of the mountain at the ground.  It has the shape
\begin{align}
	\phi(x, z) &= \phi_0 \left\{ \begin{array}{l l}
		\cos^2 \left( \frac{\pi r}{2} \right) & \quad \text{if $r \leq 1$} \\
		0 & \quad \text{otherwise}
	\end{array} \right.
%
\intertext{with radius $r$ given by}
%
	r &= \sqrt{
		\left( \frac{x - x_0}{A_x} \right)^2 + 
		\left( \frac{z - z_0}{A_z} \right)^2
	}
\end{align}
where $A_x = \SI{25}{\kilo\meter}$, $A_z = \SI{10}{\kilo\meter}$ are the horizontal and vertical half-widths respectively, and $\phi_0 = \SI{1}{\kilogram\per\meter\cubed}$ is the maximum density of the tracer.  At $t = \SI{0}{\second}$, the tracer is centred at $(x_0, z_0) = (\SI{-50}{\kilo\meter}, \SI{0}{\kilo\meter})$ so that the tracer is upwind of the mountain and centred at the ground.

\begin{table}
	\centering
\begin{tabular}{l S S}
\hline
	Mesh type & {Time-step (\si{\second})} & {Maximum Courant number} \\
\hline
	BTF & 8 & 0.417 \\
	Cut cell & 0.5 & 0.376 \\
	Slanted cell & 5 & 0.409 \\
\hline
\end{tabular}
%
	\caption{Time-step values and corresponding maximum Courant numbers for the two-dimensional transport test over terrain.  The time-steps were chosen so that the maximum Courant number was about \num{0.4}.}
	\label{tab:mountainAdvection:timesteps}
\end{table}

Tests are integrated forward for \SI{10000}{\second}, by which time the tracer has moved downwind of the mountain.  Different time-steps were chosen for each mesh so that the maximum Courant number was approximately \num{0.4} (table~\ref{tab:mountainAdvection:timesteps}).
An analytic solution at \SI{10000}{\second} is obtained by calculating the new horizontal position of the tracer.  Integrating along the trajectory yields $t$, the time taken to move from the left side of the mountain to the right:
\begin{align}
	\mathrm{d}t &= \mathrm{d}x / u(x) \\
	t &= \int_0^x \frac{H - h(x)}{u_0 H}\:\mathrm{d}x \\
	t &= \frac{x}{u_0} - \frac{h_0}{16 u_0 H} \left[ 4x + \frac{\sin 2 (\alpha + \beta) x}{\alpha + \beta} \right.+ \nonumber \\
   &\ \left. \frac{\sin 2(\alpha - \beta) x}{\alpha - \beta} + 2 \left( \frac{\sin 2\alpha x}{\alpha} + \frac{\sin 2\beta x}{\beta} \right) \right]
\end{align}
By solving this equation we find that \(x(t=\SI{10000}{\second}) = \SI{54342.8}{\meter}\).

\begin{figure}
	\centering
	\includegraphics{../fig-mountainAdvection-tracer/fig-mountainAdvection-tracer.pdf}
	\caption{Evolution of the tracer in the two-dimensional transport test over steep terrain.  The tracer is transported to the right over the wave-shaped terrain.  Tracer contours are every \SI{0.1}{\kilo\gram\per\meter\cubed}.  The result obtained using the cubicFit scheme on the basic terrain-following mesh is shown at $t=\SI{0}{\second}$, $t=\SI{5000}{\second}$ and $t=\SI{10000}{\second}$ with solid black contours. The analytic solution at $t=\SI{10000}{\second}$ is shown with dotted contours.
	The shaded box indicates the region that is plotted in figure~\ref{fig:mountainAdvection-errors}.}
	\label{fig:mountainAdvection-tracer}
\end{figure}

Tracer contours at the initial time $t=\SI{0}{\second}$, half-way time $t=\SI{5000}{\second}$, and end time $t=\SI{10000}{\second}$ are shown in figure~\ref{fig:mountainAdvection-tracer} using the cubicFit scheme on the BTF mesh.  As apparent at $t=\SI{5000}{\second}$, the tracer is distorted by the terrain-following velocity field as it passes over the mountain, but its original shape is restored once it has cleared the mountain by $t=\SI{10000}{\second}$.
A small phase lag is apparent when the numerical solution marked with solid contour lines is compared with the analytic solution marked with dotted contour lines.

\begin{figure}
	\centering
	\includegraphics{../fig-mountainAdvection-error/fig-mountainAdvection-error.pdf}
	\caption{Tracer contours at $t=\SI{10000}{\second}$ for the two-dimensional tracer transport tests.  A region in the lee of the mountain is plotted corresponding to the shaded area in figure~\ref{fig:mountainAdvection-tracer}.  Results are presented on BTF, cut cell and slanted cell meshes (shown in figure~\ref{fig:mountainAdvection-meshes}) using the linearUpwind and cubicFit transport schemes.  The numerical solutions are marked by solid black lines.  The analytic solution is marked by dotted lines.  Contours are every \SI{0.1}{\kilo\gram\per\meter\cubed}.}
	\label{fig:mountainAdvection-errors}
\end{figure}

Numerical errors are more clearly revealed by subtracting the analytic solution from the numerical solution.  This enables the calculation of error norms,
\begin{align}
	\ell_2 &= \sqrt{\frac{\sum_c \left(\phi - \phi_T \right)^2 \mathcal{V}_c}{\sum_c \left(\phi_T^2 \mathcal{V}_c \right)}} \\
	\ell_\infty &= \frac{\max_c |\phi - \phi_T|}{\max_c |\phi_T|}
\end{align}
where $\phi$ is the numerical value, $\phi_T$ is the analytic value, $\sum_c$ denotes a summation over all cells $c$ in the domain, and $\max_c$ denotes a maximum value of any cell.

Errors are compared between BTF, cut cell and slanted cell meshes using the linearUpwind scheme (figures~\ref{fig:mountainAdvection-errors}a, \ref{fig:mountainAdvection-errors}b and \ref{fig:mountainAdvection-errors}c respectively) and the cubicFit scheme (figures~\ref{fig:mountainAdvection-errors}d, \ref{fig:mountainAdvection-errors}e and \ref{fig:mountainAdvection-errors}f respectively).
Results are least accurate using the linearUpwind scheme on the slanted cell mesh (figure~\ref{fig:mountainAdvection-errors}c).  The final tracer is slightly distorted and does not extend far enough towards the ground.  The error magnitude is reduced by using the linearUpwind scheme on the cut cell mesh (figure~\ref{fig:mountainAdvection-errors}b), but the error's shape remains the same.
The cubicFit scheme is less sensitive to the choice of mesh with similar error magnitudes on the BTF mesh (figure~\ref{fig:mountainAdvection-errors}d), cut cell mesh (figure~\ref{fig:mountainAdvection-errors}e) and slanted cell mesh (figure~\ref{fig:mountainAdvection-errors}f).  Errors using the cubicFit scheme on cut cell and slanted cell meshes are much smaller than the errors using the linearUpwind scheme on the same meshes.

\begin{figure}
	\centering
	\includegraphics{../fig-mountainAdvection-l2ByMountainHeight/fig-mountainAdvection-l2ByMountainHeight.pdf}
%
	\caption{Error measures for the two-dimensional tracer transport tests with peak mountain heights $h_0$ from \SIrange{0}{6}{\kilo\meter}.  Results are compared on BTF, cut cell and slanted cell meshes using the linearUpwind and cubicFit schemes.  At $h_0 = \SI{0}{\kilo\meter}$ the terrain is entirely flat and the BTF, cut cell and slanted cell meshes are identical.  At $h_0 = \SI{6}{\kilo\meter}$ the linearUpwind scheme is unstable on the slanted cell mesh.}
	\label{fig:mountainAdvection-l2ByMountainHeight}
\end{figure}

To further examine the performance of the cubicFit scheme in the presence of steep terrain, a second series of tests were performed in which the peak mountain height was varied from \SIrange{0}{6}{\kilo\meter} keeping all other parameters constant.  Results were obtained on BTF, cut cell and slanted cell meshes using the linearUpwind scheme and cubicFit scheme.  \TODO{hold the max Courant number around 0.4 again}.  The $\ell_2$ error for these tests is presented in figure~\ref{fig:mountainAdvection-l2ByMountainHeight}.
In all cases, error increases with increasing mountain height because steeper slopes lead to greater mesh distortions.
Errors are identical for a given transport scheme when $h_0 = \SI{0}{\kilo\meter}$ and the ground is entirely flat because the BTF, cut cell and slanted cell meshes are identical.
Compared with the cubicFit scheme, the linearUpwind scheme is more sensitive to the mesh type and mountain height.  The linearUpwind scheme is unstable on the slanted cell mesh with a peak mountain height $h_0 = \SI{6}{\kilo\meter}$ despite using a stable Courant number of \TODO{\num{0.4}ish}.
In contrast, the cubicFit scheme is less sensitive to the mesh type and errors grow more slowly with increasing mountain height.  The cubicFit scheme yields stable results in all tests.

\begin{figure}
	\centering
	\includegraphics{../fig-mountainAdvection-maxdt/fig-mountainAdvection-maxdt.pdf}
	\caption{Longest stable timesteps, $\Delta t_\mathrm{max}$, for the two-dimensional tracer transport test on basic terrain-following, cut cell and slanted cell meshes at mesh spacings between $\Delta x = \SI{5000}{\meter}$ and $\Delta x = \SI{125}{\meter}$.  The tests were integrated with a maximum Courant number close to 1, while $\Delta t_\mathrm{max}$ is calculated as the timestep corresponding to a maximum Courant number of exactly 1.
	\TODO{I have only calculated the numbers for this plot, I haven't yet run all the tests themselves at Co close to one.  I have at least run \textit{some} tests at $Co \approx 1$ and there were no issues.}}
	\label{fig:mountainAdvection-maxdt}
\end{figure}

A final series of tests were performed on BTF, slanted cell and cut cell meshes using a variety of mesh spacings between $\Delta x = \SI{5000}{\meter}$ and $\Delta x = \SI{125}{\meter}$.  $\Delta z$ was chosen so that a constant aspect ratio is preserved such that $\Delta x / \Delta z = 2$.  In order to verify that cubicFit is accurate near the stability limit, timesteps were chosen so that the maximum Courant number was close to one.  \TODO{(check this is true:) Results were accurate in all tests and the scheme was largely insensitive to the choice of timestep.}

This series of tests also enables a comparison of longest stable timesteps between mesh types.  The longest stable timestep for a maximum Courant number of one can be calculated as $\Delta t_\mathrm{max} = \Delta t / \max{\mathrm{Co}}$ where $\Delta t$ is the timestep used in a particular test run and $\max{\mathrm{Co}}$ is the maximum Courant number for that test run.
\TODO{For example, on the BTF mesh with $\Delta x = \SI{123}{\meter}$ and $\Delta t = \SI{456}{\second}$ the maximum Courant number was $\max{\mathrm{Co}} = 789$.  The longest stable timestep is then $\Delta t_\mathrm{max} = \SI{345}{\second}$.}

The longest stable timesteps for BTF, cut cell and slanted cell meshes are presented in figure~\ref{fig:mountainAdvection-maxdt}.  BTF meshes permit the longest timesteps of all three meshes since cells are almost uniform in volume.  As expected, the longest stable timestep scales linearly with BTF mesh spacing.
There is no such linear scaling on cut cell meshes because these meshes can have arbitrarily small cells.  The timestep constraints on cut cell meshes are the most severe of the three mesh types.  Slanted cell meshes have a slightly stronger timestep constraint than BTF meshes, but still exhibit the same, predictable linear scaling with mesh spacing.

The transport tests presented in this section demonstrate that the cubicFit scheme is suitable for flows over very steep terrain on two-dimensional terrain-following, cut cell and slanted cell meshes.  The cubicFit scheme is less sensitive to the mesh type and mountain steepness compared to the linearUpwind scheme.  The linearUpwind scheme becomes unstable over very steep slopes but the cubicFit scheme is stable for all tests.  In the next section, we evaluate the cubicFit scheme using more complex, deformational flows on icosahedral meshes and cubed-sphere meshes.
