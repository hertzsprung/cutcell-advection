\section*{Appendix B: Mesh geometry on a spherical Earth}

The cubicFit transport scheme is implemented using the OpenFOAM CFD library.  Unlike many atmospheric models that use spherical coordinates, OpenFOAM uses global, three-dimensional Cartesian coordinates.  In order to perform the experiments on a spherical Earth presented in section~\ref{sec:deformationSphere}, it is necessary for velocity fields and mesh geometries to be expressed in these global Cartesian coordinates.

\subsection*{Velocity field specification}
The non-divergent velocity field in section~\ref{sec:deformationSphere} is specified as a streamfunction $\Psi(\lambda, \theta)$.  Instead of calculating velocity vectors, the flux $\mathbf{u}_f \cdot \mathbf{S}_f$ through a face $f$ is calculated directly from the streamfunction,
\begin{align}
	\mathbf{u}_f \cdot \mathbf{S}_f	= \sum_{e\:\in\:f} \mathbf{e} \cdot \mathbf{x}_e \Psi(e) \label{eqn:nondiv-spherical-flux}
\end{align}
where $e \in f$ denotes the edges $e$ of face $f$, $\mathbf{e}$ is the edge vector joining its two vertices, $\mathbf{x}_e$ is the position vector of the edge midpoint, and $\Psi(e)$ is the streamfunction evaluated at the same position.
Edge vectors are directed in a counter-clockwise orientation.

\subsection*{Spherical mesh construction}

Since OpenFOAM does not support two-dimensional spherical meshes, instead, we construct meshes that have a single layer of cells that are \SI{2000}{\meter} deep, having an inner radius $r_1 = R_e - \SI{1000}{\meter}$ and an outer radius $r_2 = R_e + \SI{1000}{\meter}$.
By default, OpenFOAM meshes comprise polyhedral cells with straight edges and flat faces.  This is problematic for spherical meshes because face areas and cell volumes are too small.
For tests on a spherical Earth, we override the default configuration and calculate our own face areas, cell volumes, face centres and cell centres that account for the spherical geometry.  
Faces are assumed to be either surface faces or radial faces.  Surface faces have any number of vertices, all of equal radius.  Radial faces have four vertices with two different radii, $r_1$ and $r_2$, and two different horizontal coordinates, $(\lambda_1, \theta_1)$ and $(\lambda_2, \theta_2)$.
Surface face centres are modified so that they have the radius $R_e$.  The latitudinal and longitudinal components of face centres need no modification.  Radial face centres need no modification, either.
The face area $A_f$ for a radial face $f$ is the area of the annular sector,
\begin{align}
	A_f = \frac{d}{2} \left\lvert r_2^2 - r_1^2 \right\rvert
\end{align}
where $d$ is the great-circle distance between $(\lambda_1, \theta_1)$ and $(\lambda_2, \theta_2)$.
\TODO{surface face areas look more difficult --- I might need some help describing this}

\TODO{I don't know how the following formulae were obtained}
Cell centres and cell volumes are corrected by considering faces that are not normal to the sphere such that
\begin{align}
	\frac{\left(\mathbf{S}_f \cdot \mathbf{x}_f\right)^2}{\left\lvert \mathbf{S}_f \right\rvert^2 \left\lvert \mathbf{x}_f \right\rvert^2} > 0 \label{eqn:surface-faces}
\end{align}
\TODO{in this case we use a more general method for identifying surface faces than we used for face correction.  why?}
Let $\mathcal{F}$ be the set of faces satisfying equation~\eqref{eqn:surface-faces}.  Then, the cell volume $\mathcal{V}_c$ is
\begin{align}
	\mathcal{V}_c = \frac{1}{3} \sum_{f\:\in\:\mathcal{F}} \mathbf{S}_f \cdot \mathbf{x}_f
\end{align}
where $\mathbf{x}_f$ is the centre of face $f$.
The cell centre $\mathbf{x}_c$ is
\begin{align}
	\mathbf{x}_c = \frac{\sqrt{\frac{1}{3} \left(r_1^2 + r_1 r_2 + r_2^2\right)}\sum_{f\in\mathcal{F}} \mathbf{x}_f}{\left\lvert \sum_{f\in\mathcal{F}} \mathbf{x}_f \right\rvert}
\end{align}

Edges can be classified in a similar manner to faces where surface edges are tangent to the sphere and radial faces are normal to the sphere.  The edge midpoints, $\mathbf{x}_e$, are used to calculate the face flux for non-divergent winds (equation~\eqref{eqn:nondiv-spherical-flux}).
For transport tests, corrections to edge midpoint calculations unnecessary.  Due to the choice of $r_1$ and $r_2$ during mesh construction, the midpoint of a radial edge is at a radial distance of $R_e$ which is necessary for the correct calculation of non-divergent winds.
The position of surface edge midpoints is unimportant because these edges do not contribute to the face flux since $\mathbf{e} \cdot \mathbf{x}_e = 0$.
Edge lengths are the straight-line distance between the two vertices and not the great-circle distance.  Again, the edge lengths are not corrected because it makes no difference to the face flux calculation.

\subsection*{Tangent plane projection of the cubicFit stencil}
\TODO{cubicFit stencil projection from 3D into 2D}
