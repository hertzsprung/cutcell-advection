\documentclass{article}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{xcolor}
\usepackage{bm}

\title{Multidimensional Cubic Upwind-Biased Advection of Slanted Cell Grids}

\newcommand{\iunit}{\boldsymbol{\hat \imath}}
\newcommand{\junit}{\boldsymbol{\hat \jmath}}
\newcommand{\kunit}{\boldsymbol{\hat k}}
\newcommand{\TODO}[1]{\textcolor{purple}{TODO: \emph{#1}}}
\begin{document}
\maketitle

\section{Slanted cell grids}
See figure~\ref{fig:grid-generation}
\begin{figure}
	\centering
	\includegraphics{../fig-grid-generation/fig-grid-generation.pdf}
	%
	\caption{Illustration of a slanted cell grid (a) before, and (b) after construction.
	The terrain surface, denoted by a heavy dotted line, intersects a uniform rectangular grid comprising four cells, $c_1$, $c_2$, $c_3$ and $c_4$.  The cell vertices, marked by open circles, are moved upwards to the points at which the terrain intersects vertical cell edges, marked by open circles.  Cells that have no volume are removed.  Where a cell has two vertices occupying the same point, the zero-length edge that joins those vertices is removed.  In this illustration, cell $c_4$ is removed because it has no volume, and the zero-length edge at point $p$ is removed to create a triangular cell, $c_3$.}
	\label{fig:grid-generation}
\end{figure}

\section{Multidimensional upwind-biased advection scheme}
A tracer with density $\phi$ is advected in flux form
\begin{align}
\partial \phi / \partial t + \nabla \cdot \left( \mathbf{u} \phi \right) = 0
\end{align}
where $\mathbf{u}$ is the velocity field.  We use the notation that, for a field $\psi$, $\psi_f$ denotes the value of $\psi$ at face $f$, $\psi_c$ denotes the value at the centroid of cell $c$, and $\psi_F$ is an interpolation onto a face from surrounding cell centre values.  The divergence term is discretised using Gauss' divergence theorem:
\begin{align}
	\nabla \cdot \left( \mathbf{u} \phi \right) \approx \frac{1}{\mathcal{V}} \sum_{f \in c} \phi_F \mathbf{u}_f \cdot \mathbf{S}_f
\end{align}
where $\mathcal{V}$ is the cell volume, $f \in c$ denotes the faces of the cell, and $\mathbf{S}_f$ is the outward-pointing normal vector for face $f$ with a magnitude equal to the face area.
The value of $\phi_F$ is interpolated using a least squares fit of cell centre values from an upwind-biased stencil.
\begin{figure}
	\centering
	\includegraphics{../fig-upwind-stencil/fig-upwind-stencil.pdf}
	%
	\caption{\TODO{}}
	\label{fig:upwind-stencil}
\end{figure}

\subsection{Stencil construction}
The upwind-biased stencil is constructed by finding the opposing faces for a given face, $f$, belonging to a cell, $c$.  Defining $G$ to be the set of other faces in cell $c$, we calculate the `opposedness', $\mathrm{Opp}$, between faces $f$ and $g \in G$, defined as
\begin{align}
	\mathrm{Opp}(f, g) \equiv - \frac{\mathbf{S}_f \cdot \mathbf{S}_g}{|\mathbf{S}_f|^2} \label{eqn:opp}
\end{align}
where $\mathbf{S}_f$ and $\mathbf{S}_g$ are the surface normal vectors pointing outward from cell $c$ for faces $f$ and $g$ respectively.
Using the fact that $\mathbf{a} \cdot \mathbf{b} = |\mathbf{a}|\:|\mathbf{b}| \cos(\theta)$ we can rewrite equation~\ref{eqn:opp}:
\begin{align}
	\mathrm{Opp}(f, g) = - \frac{|\mathbf{S}_g|}{|\mathbf{S}_f|} \cos(\theta)
\end{align}
where $\theta$ is the angle between faces $f$ and $g$.  In this form, it can be seen that $\mathrm{Opp}$ is a measure of the area of $g$ and how closely it parallels face $f$.

Now, let $\mathrm{OF}$ be the set of faces opposing face $f$, which is defined as
\begin{align}
	\mathrm{OF} \equiv \{ g : \max(\mathrm{Opp}(f, g)) \} \cup \{ g : \mathrm{Opp}(f, g) \geq 0.5 \}
\end{align}
\TODO{can the opposed face be a boundary face?  I think this is desirable in order to find the upwind cell centre...}
The stencil includes cells adjacent to the faces in $\mathrm{OF}$, and their vertex neighbours.

\begin{figure}
	\centering
	\includegraphics{../fig-double-upwind-stencil/fig-double-upwind-stencil.pdf}
	%
	\caption{A thirteen-cell, upwind-biased stencil for face $f$ belonging to a pentagonal cell, $c$.  The dashed lines denote the two faces of cell $c$ that oppose $f$, and grey circles mark the centroids of the cells neighbouring the two opposing faces.  The stencil is expanded outwards by including cells that neighbour the vertices of the three central cells, where black squares mark these vertices.  The local coordinate system $(x, y)$ has its origin at the centroid of face $f$, marked by an open circle, with $x$ normal to $f$ and $y$ perpendicular.}
	\label{fig:double-upwind-stencil}
\end{figure}

Figure~\ref{fig:double-upwind-stencil} illustrates a stencil construction for face $f$ and cell $c$.  The two opposing faces are denoted by thick dashed lines and the centres of the three neighbouring cells are marked by grey circles.  The stencil is extended outwards from the central cells by including the cells neighbouring the vertices marked by black squares.  The resultant stencil contains 13 cells.

\subsection{Singular value decomposition}
Once the stencil has been found, a multidimensional polynomial is fitted to the cell centre values.
In two dimensions, the polynomial is
\begin{align}
	\phi = a_1 + a_2 x + a_3 y + a_4 x^2 + a_5 xy + a_6 y^2 + a_7 x^3 + a_8 x^2 y + a_9 x y^2
\end{align}
where $\mathbf{a} = [a_1, \ldots, a_n]^\intercal$ is the vector of unknown coefficients with $n=9$ in two dimensions.  A local coordinate system is established in which $x$ is in the direction of $\mathbf{S}_f$ and $y$ is perpendicular to $x$.
\TODO{in 3D, how do we choose y and z? does it even matter?}
The origin of the local coordinate system is fixed to be the target face centroid.
Note that the term involving $y^3$ is omitted.

A matrix equation is constructed to calculate a least squares fit:
\begin{align}
	\mathbf{B} \mathbf{w'_p} \mathbf{a} = \mathbf{w_c} \bm{\phi}
\end{align}
where $\mathbf{B}$ is a rectangular matrix with one row for each cell in the stencil and one column for each term in the polynomial, $\mathbf{w'_p} = [w_{p1}^{-1}, \ldots, w_{pn}^{-1}]^\intercal$ is the polynomial weight reciprocal vector with $n$ being the number of polynomial terms,  $\mathbf{w_c} = [w_{c1}, \ldots, w_{cm}]^\intercal$ is the cell weights vector with $m$ being the number of cells in the stencil, and $\bm{\phi} = [\phi_1, \ldots, \phi_m]^\intercal$ is the vector of cell centre tracer densities.
The matrix $\mathbf{B}$ takes the form
\begin{align}
	\mathbf{B} = \left( \mathbf{W_P} \left( \mathbf{W_C} \mathbf{\tilde{B}} \right)^\intercal \right)^\intercal \label{eqn:B}
\end{align}
where $\mathbf{W_P} = \mathrm{diag}(\mathbf{w_p})$ is a $n \times n$ matrix of polynomial weights and $\mathbf{w_p} = [w_{p1}, \ldots, w_{pn}]^\intercal$, and $\mathbf{W_C} = \mathrm{diag}(\mathbf{w_c})$ is a $m \times m$ matrix of cell weights.  Equation~\ref{eqn:B} is constructed so that the rows of $\mathbf{\tilde{B}}$ are multiplied by the corresponding cell weights in $\mathbf{w_c}$, and the columns of $\mathbf{\tilde{B}}$ are multiplied by the corresponding polynomial weights in $\mathbf{w_p}$.

$\mathbf{\tilde{B}}$ is a $m \times n$ matrix of the geometric terms in the polynomial which, in two dimensions, is given by
\begin{align}
	\mathbf{\tilde{B}} = 
	\begin{pmatrix}
		1 & \mathbf{X}_{1,1} & \mathbf{X}_{1,1} & \mathbf{X}_{1,1}^2 & \mathbf{X}_{1,1} \mathbf{X}_{1,2} & \mathbf{X}_{1,2}^2 & \mathbf{X}_{1,1}^3 & \mathbf{X}_{1,1}^2 \mathbf{X}_{1,2} & \mathbf{X}_{1,1} \mathbf{X}_{1,2}^2 \\
		\vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
		1 & \mathbf{X}_{m,1} & \mathbf{X}_{m,1} & \mathbf{X}_{m,1}^2 & \mathbf{X}_{m,1} \mathbf{X}_{m,2} & \mathbf{X}_{m,2}^2 & \mathbf{X}_{m,1}^3 & \mathbf{X}_{m,1}^2 \mathbf{X}_{m,2} & \mathbf{X}_{m,1} \mathbf{X}_{m,2}^2 \\
	\end{pmatrix}
\end{align}
where $\mathbf{X}$ is a matrix with $m$ rows and one column for each geometric dimension.  
Each row of the $\mathbf{X}$ matrix contains the local coordinates of a cell centroid so that, in two dimensions, the matrix is
\begin{align}
	\mathbf{X} = 
	\begin{pmatrix}
		x_1 & y_1 \\
		x_2 & y_2 \\
		\vdots & \vdots \\
		x_m & y_m
	\end{pmatrix}
\end{align}

A singular value decomposition is used to calculate the pseudo-inverse of $\mathbf{B}$, $\mathbf{B}^+$, such that
\begin{align}
	\mathbf{B}^+ \mathbf{w_c} \bm{\phi} = \mathbf{w'_p} \mathbf{a}
%
\shortintertext{and noting that $\mathbf{w'_p}$ is the reciprocal of $\mathbf{w_p}$ to find the unknown polynomial coefficients:}
%
	\mathbf{a} = \mathbf{B}^+ \mathbf{w_c} \mathbf{w_p} \bm{\phi}
\end{align}
The expression $\mathbf{B}^+ \mathbf{w_c} \mathbf{w_p}$ can be calculated once because it depends only upon the cell weights, polynomial weights and grid geometry, which is assumed to be static.

\subsection{Iterative weight adjustment for upwind-biased fit}

% procedure:
% for each face and for both orientations:
% 1. find stencil
% 3. give upwind cell weighting of 1000
% 5. *1000 for 'a' and 'b' terms
% (rescale and reorientate, probably not crucial to mention)
% iterate up to 8 times (and at least once)
%   SVD for "B"
%   coeffsi[i] = 1000 * weight[i] * VSinvUt[0][i]
%   test for good fit criteria:
%   - mag(upwind cell weight correction) < linearLimitFactor
%   - upwind weight > downwind weight
%   - upwind weight > sum(other positive weights)
%   - max(weight) < 1
%   if good fit criteria are not met:
%   - upwind input weight *= 10
%   - remove downwind 1000 weighting (in wts and in B matrix) on the first iteration
%   - multiply all upwind weights by 10 in the SVD matrix
%   - multiply a and b polynomial terms by 10 for all cells
% finally, if good fit criteria are still not met, revert to standard 'upwind': phi_F \approx phi_U

% how do we find the contributing cells?
% what do we do if there aren't enough cells?
% need to define terminology for "weights":
% - weights fed into SVD
% - weights that come out of SVD

% linearLimitFactor documented in UpwindCorrFitScheme.H, is specified in fvSchemes, we have it set to 3

\end{document}
