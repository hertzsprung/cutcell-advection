\section*{Appendix B: Mesh geometry on a spherical Earth}

The cubicFit transport scheme is implemented using the OpenFOAM CFD library.  Unlike many atmospheric models that use spherical coordinates, OpenFOAM uses global, three-dimensional Cartesian coordinates.  In order to perform the experiments on a spherical Earth presented in section~\ref{sec:deformationSphere}, it is necessary for velocity fields and mesh geometries to be expressed in these global Cartesian coordinates.

\subsection*{Velocity field specification}
The non-divergent velocity field in section~\ref{sec:deformationSphere} is specified as a streamfunction $\Psi(\lambda, \theta)$.  Instead of calculating velocity vectors, the flux $\mathbf{u}_f \cdot \mathbf{S}_f$ through a face $f$ is calculated directly from the streamfunction,
\begin{align}
	\mathbf{u}_f \cdot \mathbf{S}_f	= \sum_{e\:\in\:f} \mathbf{e} \cdot \mathbf{x}_e \Psi(e) \label{eqn:nondiv-spherical-flux}
\end{align}
where $e \in f$ denotes the edges $e$ of face $f$, $\mathbf{e}$ is the edge vector joining its two vertices, $\mathbf{x}_e$ is the position vector of the edge midpoint, and $\Psi(e)$ is the streamfunction evaluated at the same position.
Edge vectors are directed in a counter-clockwise orientation.

\subsection*{Spherical mesh construction}

Since OpenFOAM does not support two-dimensional spherical meshes, instead, we construct meshes that have a single layer of cells that are \SI{2000}{\meter} deep, having an inner radius $r_1 = R_e - \SI{1000}{\meter}$ and an outer radius $r_2 = R_e + \SI{1000}{\meter}$.
By default, OpenFOAM meshes comprise polyhedral cells with straight edges and flat faces.  This is problematic for spherical meshes because face areas and cell volumes are too small.
For tests on a spherical Earth, we override the default configuration and calculate our own face areas, cell volumes, face centres and cell centres that account for the spherical geometry.  

A face is assumed to be either a surface face or radial face.
A surface face has any number of vertices, all of equal radius.
A radial faces have four vertices with two different radii, $r_1$ and $r_2$, and two different horizontal coordinates, $(\lambda_1, \theta_1)$ and $(\lambda_2, \theta_2)$.
A radial face centre is modified so that it has a radius $R_e$.  The latitudinal and longitudinal components of a radial face centre needs no modification. \TODO{although the code does recalculate this anyway!}
The face area $A_f$ for a radial face $f$ is the area of the annular sector,
\begin{align}
	A_f = \frac{d}{2} \left\lvert r_2^2 - r_1^2 \right\rvert
\end{align}
where $d$ is the great-circle distance between $(\lambda_1, \theta_1)$ and $(\lambda_2, \theta_2)$.

To calculate the centre of a surface face $f$, a new vertex is created that is positioned at the mean of the face vertices.  Note that this centre position, $\mathbf{\tilde{c}}_f$, is used in intermediate calculations and it is not the face centre position.
Next, the surface face is subdivided into triangles that share this new vertex.
The face centre direction and radius are calculated separately.  The face centre direction $\mathbf{\hat{r}}$ is the mean of the triangle centres weighted by their solid angle
\begin{align}
	\mathbf{\hat{r}} = \frac
	{\sum_{t\:\in\:f}{\Omega_t \left(\mathbf{x}_{t,1} + \mathbf{x}_{t,2} + \mathbf{\tilde{c}}_f \right)}}
	{\left\lvert \sum_{t\:\in\:f}{\Omega_t \left(\mathbf{x}_{t,1} + \mathbf{x}_{t,2} + \mathbf{\tilde{c}}_f \right)} \right\rvert} \label{eqn:face-centre-dir}
\end{align}
where $t\in f$ denotes the triangles $t$ of face $f$, $\Omega_t$ is triangle's solid angle which is calculated using l'Huilier's theorem, $\mathbf{x}_{t,1}$ and $\mathbf{x}_{t,2}$ are the positions of the vertices shared by the face $f$ and triangle $t$, and $\mathbf{\tilde{c}}_f$ is the position of the centre vertex shared by all triangles of face $f$.
The face centre radius $r$ is the mean radius of the face vertices, again weighted by the solid angle of each triangle,
\begin{align}
	r = \frac
	{\sum_{t\in f}{\Omega_t \left(\left\lvert \mathbf{x}_{t,1} \right\rvert + \left\lvert \mathbf{x}_{t,2} \right\rvert \right)/2}}
	{\sum_{t\in f}{\Omega_t}} \label{eqn:face-centre-mag}
\end{align}
We use equations~\eqref{eqn:face-centre-dir} and \eqref{eqn:face-centre-mag} to calculate the centre $\mathbf{c}_f$ of the face,
\begin{align}
	\mathbf{c}_f = r\:\mathbf{\hat{r}}
\end{align}
\TODO{surface face area -- calculate the solid angle of each triangle and sum up to obtain the solid angle of the polygon, $\Omega$, then use the equation $A = r^2 \Omega$.
The code has $A = r^2 \Omega \mathbf{\hat{r}} \cdot \left\lvert \sum_{t \in f}{\mathbf{n}} \cdot \mathbf{\hat{r}} \right\rvert$.
I understand most of this except for the rescaling by $\left\lvert \sum{\mathbf{n}} \cdot \mathbf{\hat{r}} \right\rvert$ where $\mathbf{n} = \left( \mathbf{x}_{t,2} - \mathbf{x}_{t,1} \right) \times \left( \mathbf{\tilde{c}}_f - \mathbf{x}_{t,1} \right)$.
Note that $\mathbf{n}$ is normal to the spherical triangle at $\mathbf{x}_{t,1}$ but it is not a unit vector.}

\TODO{I don't know how the following formulae were obtained}
Cell centres and cell volumes are corrected by considering faces that are not normal to the sphere such that
\begin{align}
	\frac{\left(\mathbf{S}_f \cdot \mathbf{c}_f\right)^2}{\left\lvert \mathbf{S}_f \right\rvert^2 \left\lvert \mathbf{c}_f \right\rvert^2} > 0 \label{eqn:surface-faces}
\end{align}
\TODO{in this case we use a more general method for identifying surface faces than we used for face correction.  why?}
Let $\mathcal{F}$ be the set of faces satisfying equation~\eqref{eqn:surface-faces}.  Then, the cell volume $\mathcal{V}_c$ is
\begin{align}
	\mathcal{V}_c = \frac{1}{3} \sum_{f\:\in\:\mathcal{F}} \mathbf{S}_f \cdot \mathbf{c}_f
\end{align}
\TODO{the above comes from $\int_0^R{A(r)\:\mathrm{d}r} = \int_0^R{R^2 \Omega\:\mathrm{d}r} = \frac{1}{3} R^3 \Omega$.  I can see why this works for radially-extruded meshes, which is all we use in this paper.}
The cell centre position $\mathbf{c}_c$ is
\begin{align}
	\mathbf{c}_c = \frac{\sqrt{\frac{1}{3} \left(r_1^2 + r_1 r_2 + r_2^2\right)}\sum_{f\in\mathcal{F}} \mathbf{c}_f}{\left\lvert \sum_{f\in\mathcal{F}} \mathbf{c}_f \right\rvert}
\end{align}
\TODO{I still don't know where this comes from.}

Edges can be classified in a similar manner to faces where surface edges are tangent to the sphere and radial faces are normal to the sphere.  The edge midpoints, $\mathbf{c}_e$, are used to calculate the face flux for non-divergent winds (equation~\eqref{eqn:nondiv-spherical-flux}).
For transport tests, corrections to edge midpoints are unnecessary.  Due to the choice of $r_1$ and $r_2$ during mesh construction, the midpoint of a radial edge is at a radial distance of $R_e$ which is necessary for the correct calculation of non-divergent winds.
The position of surface edge midpoints is unimportant because these edges do not contribute to the face flux since $\mathbf{e} \cdot \mathbf{c}_e = 0$.
Edge lengths are the straight-line distance between the two vertices and not the great-circle distance.  Again, the edge lengths are not corrected because it makes no difference to the face flux calculation.

\subsection*{Tangent plane projection of the cubicFit stencil}
\TODO{cubicFit stencil projection from 3D into 2D.  We should probably use a projection onto a tangent plane at the face centroid.  But that's not quite what we do at the moment.}

